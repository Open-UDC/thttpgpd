#!/bin/bash

helpmsg='Usage: '"${0##*/}"' [options]
Options:
	-d, --dir	directory (default: $HOME of .ludd user if root, or $HOME/.ludd if not).
	-h, --help	this help
	-V, --version	version'

function ludd_chooseinlist {
# Argument 1: Prompt before the list
# Argument 2(optionnal): if argument 2 is a number>0, it indicates the number of item by line - defaut: 3.
# Arguments 2,3...n : items to choose
# Return the number of the choosen item, 0 if no items.

	local ret=0 nperline=3 n
	echo -n "$1"
	shift
	(($1>0)) && nperline=$1 && shift
	n=$#
	for ((i=0;$#;)) ; do
		if ((i%nperline)) ; then
			echo -en "\t\t"
		else
			echo -en "\n\t"
		fi
		echo -en "$((++i))) $1"
		shift
	done
	echo
	while ! ((ret)) || ((ret<1 || ret>n)) ; do
		read -p "Reply (1-$n) ? " ret
	done
	return $ret
}

function ludd_genbotkey {
	for ((;;)) ; do
		for ((;;)) ; do
			read -p "What is ur udid2 (udid2;c;...) ? " myudid
			grep "^udid2;c;[A-Z]\{1,20\};[A-Z-]\{1,20\};[0-9-]\{10\};[0-9.e+-]\{14\};[0-9]\+;\?$" <(echo $myudid) > /dev/null && break
		done
		read -p "your bot name ? " mname
		for ((;;)) ; do
			read -p "Bot email adress [Iam@unused.email] ? " email
			[[ "$email" ]] || email="Iam@unused.email"
			grep "^[^@[:space:]]\+@[^.[:space:]]\+\.[^[:space:]]\+$" <(echo $email) > /dev/null && break
		done

		echo -e "\nSummary:\n"\
				"Bot Name: $mname\n"\
				"Bot Owner: $myudid\n"\
				"email: $email\n" >&2
		read -p "Is that correct ? (y/n) " answer
		case "$answer" in
			Y* | y* | O* | o* )
				break ;;
		esac
	done


	cat << EOF | gpg --command-fd 0 --status-file /dev/null --allow-freeform-uid --gen-key --no-use-agent 2> /dev/null
4

8y
$mname
$email
udbot1;$myudid;


EOF

return $?
}

LUDDUSER="@ludduser@"
LUDDVERSION="@luddversion@"

refdir=$(grep "^"$LUDDUSER":" /etc/passwd | cut -d ":" -f 6)

if [[ ! "$refdir" ]] ; then
	echo "${0##*/}: Error: Missing ref dir (HOME of .ludd system user)"
	exit 1
fi

if (($(id -u))) ; then
	dir="$HOME/.ludd"
else
	isroot=1
	dir="$refdir"
fi

for ((i=0;$#;)) ; do
	case "$1" in
		-d|--dir*) shift; dir="$1" ;;
		-h|--h*) echo "$helpmsg" ; exit 2 ;;
		-V|--vers*) echo "$LUDDVERSION" ; exit 2 ;;
		*) echo "Error: Unrecognized option $1"; echo "$helpmsg" ; exit 2 ;;
	esac
	shift
done

mkdir -p  "$dir/gpgme" "$dir/pub/self" "$dir/pub/d" "$dir/pub/k"
if ((isroot)) ; then
	chown .ludd "$dir/pub/self" "$dir/pub/d" "$dir/pub/k"
fi

if [[ "$dir" != "$refdir" ]] ; then
	cp -avf "$refdir/pub/udid2" "$dir/pub"
	cp -avf "$refdir/pub/in" "$dir/pub"
	cp -avf "$refdir/pub/pks" "$dir/pub"
	cp -avf "$refdir/pub/c" "$dir/pub"
fi

mybotkeys=($(gpg --list-secret-keys --with-colons --with-fingerprint "udbot1;udid2;" | grep "^fpr" | cut -d: -f 10))

echo "NOTE: passphrase to cypher bot's private key is unsupported yet".
ludd_chooseinlist "bot key to use ?" 1 "create a new one" "${mybotkeys[@]}"

bki=$?
case $bki in 
	0)
		exit
		;;
	1)
		ludd_genbotkey || exit 4
		mybotkeys=($(gpg --list-secret-keys --with-colons --with-fingerprint "udbot1;udid2;" | grep "^fpr" | cut -d: -f 10))
		bki=$((${#mybotkeys[@]}-1))
		;;
	*)
		((bki-=2))
esac

myudid="$(gpg --list-secret-keys --with-colons ${mybotkeys[$bki]} | sed -n ' s/^sec:.*(udbot1;\(udid2;c;[A-Z]\{1,20\};[A-Z-]\{1,20\};[0-9-]\{10\};[0-9.e+-]\{14\};[0-9]\+\).*/\1/p ' )"
if [ -z "$myudid" ] ; then 
	echo "key ${mybotkeys[$bki]} is not a valid bot key" >&2
	exit 3
fi

while true ; do 
	read -p "Host name or addr [$(hostname)] ? " myhost
	[ "$myhost" ] || myhost="$(hostname)"
	host "$myhost" && break
done

while true ; do 
	read -p "port number [11371] ? " myport
	[ "$myport" ] || myport=11371
	((myport)) && break
done

cd "$dir"
[ -f "ludd.conf" ] && cp -v ludd.conf ludd.conf.save

cat << EOF > ludd.conf
# ludd.conf: ludd configuration file

# Commentaries are based on the ludd(8) manpage.
# ludd read the configuration file only once. So the dfault config file is not
# read if an other config file is passed, with "-C", as an argument to ludd.

# Specifies an alternate homedir for ludd.
# Note: this is ignored for the default config file, which is found in the homedir ! :-D
#dir=/var/ludd

# Specifie the fingerprint of the (secret) key to use for signing.
fpr=${mybotkeys[$bki]}

# Specifies an alternate port number to listen on.
port=$myport

# Specifie the external host name (or host adress) to reach us.
ehost=$myhost

# Specifies a hostname (and so interface) to bind to. The default is to bind to
# all hostnames supported on the local machine. See ludd(8) for details.
#host=

# Do a chroot() at initialization time, restricting file access to the program's
# current directory. If chroot is the compiled-in default, then nochroot disables
# it. See ludd(8) for details.
#nochroot
#chroot

# Specifies what user to switch to after initialization when started as root.
#user=ludd

# Specifies a wildcard pattern for CGI programs, for instance "**.cgi" or
# "/cgi-bin/*". See ludd(8) for details.
#cgipat=""

# Specifies a file of throttle settings. This feature may be removed in the futur.
# See ludd(8) for details.
#throttles=/etc/thttpd/throttle.conf

# Specifies a file for logging. If no logfile option is specified, ludd logs
# via syslog(). If logfile=/dev/null is specified, ludd doesn't log at all.
#logfile=/var/log/ludd.log

# Specifies a file to write the process-id to. If no file is specified, no
# process-id is written. You can use this file to send signals to ludd. See
# ludd(8) for details.
#pidfile=

EOF

gpg  --export-secret-keys "${mybotkeys[$bki]}" | gpg --import --homedir "$dir/gpgme"

if ! grep '^[^#]*\<import-options\>.\+\<import-clean\>' "$dir/gpgme/gpg.conf" > /dev/null ; then
	cat >> "$dir/gpgme/gpg.conf" <<EOF
### following import-option line has been added $(date -R) by ${0##*/} - $LUDDVERSION ###
import-options import-clean
EOF
fi

if ((isroot)) ; then
	chown -R .ludd "$dir/gpgme"
fi

